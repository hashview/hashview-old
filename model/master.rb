require 'rubygems'
require 'data_mapper'
require 'bcrypt'

# debug cmd:
DataMapper::Logger.new($stdout, :debug)

# use for mysql
# DataMapper.setup(:default, 'mysql://USER:PASS@localhost/DB')
# use for sqlite db
DataMapper.setup(:default, "sqlite://#{Dir.pwd}/db/master.db")

# we do this to speed up the inserts for large hash imports
# http://www.sqlite.org/faq.html#q19
adapter = DataMapper::repository(:default).adapter
adapter.select('PRAGMA synchronous = OFF;')

# User class object to handle user account credentials
class User
  include DataMapper::Resource

  property :id, Serial
  property :username, String, :key => true, :length => (3..40), :required => true
  property :hashed_password, String, :length => 128
  property :admin, Boolean
  property :created_at, DateTime, :default => DateTime.now
  property :phone, String, :required => false
  property :email, String, :required => false

  attr_accessor :password
  validates_presence_of :username

  def password=(pass)
    @password = pass
    self.hashed_password = User.encrypt(@password)
  end

  def self.encrypt(pass)
    return BCrypt::Password.create(pass)
  end

  def self.authenticate(username, pass)
    user = User.first(:username => username)
    if user
      return user.username if BCrypt::Password.new(user.hashed_password) == pass
    end
  end
end

# Class to handle authenticated sessions
class Sessions
  include DataMapper::Resource

  property :id, Serial
  property :session_key, String, :length => 128
  property :username, String, :length => (3..40), :required => true

  def self.is_valid?(session_key)
    sessions = Sessions.first(:session_key => session_key)

    return true if sessions
  end

  def self.type(session_key)
    sess = Sessions.first(:session_key => session_key)

    if sess
      if User.first(:username => sess.username).admin
        return TRUE
      else
        return FALSE
      end
    end
  end

  def self.get_username(session_key)
    sess = Sessions.first(:session_key => session_key)

    if sess
      return sess.username
    end
  end
end

# Each job generated by user will be stored here
class Jobs
  include DataMapper::Resource

  property :id, Serial
  property :name, String
  property :last_updated_by, String, :length => 40
  property :updated_at, DateTime, :default => DateTime.now
  property :status, Boolean
  property :status_detail, String, :length => 100
  property :targettype, String, :length => 2000
  property :targetfile, String, :length => 2000
  property :targethash, String, :length => 2000
  property :hashtype, Integer
  property :policy_min_pass_length, Integer
  property :policy_complexity_default, Boolean
end

# Jobs will have multiple crack tasks
class Jobtasks
  include DataMapper::Resource

  property :id, Serial
  property :job_id, Integer
  property :task_id, Integer
  property :build_cmd, String, :length => 5000
  # status options should be "Running", "Paused", "Not Started", "Completed", "Queued", "Failed", "Canceled"
  property :status, String
end

# Task definitions
class Tasks
  include DataMapper::Resource

  property :id, Serial
  property :name, String
  property :source, String
  property :mask, String
  property :command, String, :length => 4000
  property :wl_id, String, :length => 256
  property :hc_attackmode, Integer
  property :hc_rule, String
end

# Table for handle the storage of uncracked/cracked hashes per job
class Targets
  include DataMapper::Resource

  property :id, Serial
  property :updated_at, DateTime, :default => DateTime.now
  property :username, String, :length => 2000
  property :originalhash, String, :length => 4000
  property :hashtype, Integer
  property :cracked, Boolean
  property :plaintext, String, :length => 2000
  property :jobid, Integer
  property :description, String, :length => 2000

end

# User Settings
class Settings
  include DataMapper::Resource

  property :id, Serial
  property :hcbinpath, String, :length => 2000
  property :hcglobalopts, String, :length => 2000
  property :maxtasktime, String, :length => 2000
  property :maxjobtime, String, :length => 2000
  property :clientmode, Boolean
end

 class Wordlists
   include DataMapper::Resource

   property :id, Serial
   property :name, String, :length => 256
   property :path, String, :length => 2000
   property :size, Integer

 end

DataMapper.finalize

# automatically update db based on model changes
DataMapper.auto_upgrade!
